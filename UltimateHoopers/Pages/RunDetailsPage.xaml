<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:UltimateHoopers.ViewModels"
             x:Class="UltimateHoopers.Pages.RunDetailsPage"
             NavigationPage.HasNavigationBar="False"
             BackgroundColor="{StaticResource PageBackgroundColor}">

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="20"
          x:Name="MainGrid">

        <!-- Header -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,Auto"
              Margin="0,10,0,20">

            <VerticalStackLayout Grid.Column="0">
                <Label Text="{Binding Run.Name}"
                       FontSize="28"
                       FontAttributes="Bold"
                       TextColor="{StaticResource PrimaryColor}" />

                <Label Text="{Binding Run.Address}"
                       FontSize="16"
                       TextColor="{StaticResource SecondaryTextColor}" 
                       Margin="0,5,0,0"/>
            </VerticalStackLayout>

            <!-- Back Button -->
            <Frame Grid.Column="1"
                   CornerRadius="25"
                   HeightRequest="50"
                   WidthRequest="50"
                   Padding="0"
                   BorderColor="{StaticResource BorderColor}"
                   BackgroundColor="{StaticResource CardBackgroundColor}"
                   HasShadow="True">

                <Label Text="←"
                       FontSize="24"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />

                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBackClicked" />
                </Frame.GestureRecognizers>
            </Frame>
        </Grid>

        <!-- Content Area -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="20">

                <!-- Run Date & Time -->
                <Frame Padding="20"
                       CornerRadius="10"
                       HasShadow="True"
                       BorderColor="{StaticResource BorderColor}"
                       BackgroundColor="{StaticResource CardBackgroundColor}">

                    <Grid ColumnDefinitions="Auto,*" RowSpacing="15" ColumnSpacing="15">
                        <!-- Date Display -->
                        <Frame Grid.Row="0" Grid.Column="0"
                               BackgroundColor="{StaticResource PrimaryColor}"
                               CornerRadius="10"
                               Padding="10"
                               WidthRequest="70"
                               HeightRequest="70"
                               VerticalOptions="Start">
                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center">
                                <Label Text="{Binding Run.DayOfMonth}" 
                                       FontSize="22" 
                                       FontAttributes="Bold" 
                                       TextColor="White" 
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding Run.Month}" 
                                       FontSize="14" 
                                       TextColor="White" 
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Date and Time Info -->
                        <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="12">
                            <Label Text="{Binding FormattedDate}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <Grid ColumnDefinitions="Auto,*" RowSpacing="12">
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="🕒"
                                       FontSize="16"
                                       VerticalOptions="Start" />
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Run.Time}"
                                       FontSize="16"
                                       TextColor="{StaticResource PrimaryTextColor}"
                                       Margin="10,0,0,0" />

                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="📍"
                                       FontSize="16"
                                       VerticalOptions="Start" />
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Run.Address}"
                                       FontSize="16"
                                       TextColor="{StaticResource PrimaryTextColor}"
                                       Margin="10,0,0,0" />
                            </Grid>
                        </VerticalStackLayout>
                    </Grid>
                </Frame>

                <!-- Run Details -->
                <Frame Padding="20"
                       CornerRadius="10"
                       HasShadow="True"
                       BorderColor="{StaticResource BorderColor}"
                       BackgroundColor="{StaticResource CardBackgroundColor}">

                    <VerticalStackLayout Spacing="15">
                        <Label Text="Run Details"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{StaticResource PrimaryTextColor}" />

                        <Grid ColumnDefinitions="Auto,*" RowSpacing="15" ColumnSpacing="15">
                            <!-- Host Info -->
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="Host:"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}"
                                   WidthRequest="100" />
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Run.HostName}"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <!-- Skill Level -->
                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="Skill Level:"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />
                            <Label Grid.Row="1" Grid.Column="1"
                                   Text="{Binding Run.SkillLevel}"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <!-- Game Type -->
                            <Label Grid.Row="2" Grid.Column="0"
                                   Text="Game Type:"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />
                            <Label Grid.Row="2" Grid.Column="1"
                                   Text="{Binding GameTypeText}"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <!-- Cost -->
                            <Label Grid.Row="3" Grid.Column="0"
                                   Text="Cost:"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />
                            <Label Grid.Row="3" Grid.Column="1"
                                   Text="{Binding CostText}"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <!-- Privacy -->
                            <Label Grid.Row="4" Grid.Column="0"
                                   Text="Privacy:"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />
                            <Label Grid.Row="4" Grid.Column="1"
                                   Text="{Binding PrivacyText}"
                                   TextColor="{StaticResource PrimaryTextColor}" />
                        </Grid>

                        <!-- Description -->
                        <Label Text="Description"
                               FontAttributes="Bold"
                               TextColor="{StaticResource PrimaryTextColor}"
                               Margin="0,10,0,0" />
                        <Label Text="{Binding Run.Description}"
                               TextColor="{StaticResource PrimaryTextColor}"
                               LineBreakMode="WordWrap" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Player Roster -->
                <Frame Padding="20"
                       CornerRadius="10"
                       HasShadow="True"
                       BorderColor="{StaticResource BorderColor}"
                       BackgroundColor="{StaticResource CardBackgroundColor}">

                    <VerticalStackLayout Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Joined Players"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <Label Grid.Column="1"
                                   Text="{Binding Run.PlayerCountDisplay}"
                                   TextColor="{StaticResource SecondaryTextColor}" />
                        </Grid>

                        <!-- Player List Header -->
                        <Label Text="Players who have joined this run:" 
                               TextColor="{StaticResource SecondaryTextColor}"
                               FontSize="14" 
                               Margin="0,-10,0,0"
                               IsVisible="{Binding Run.HasPlayers}" />

                        <!-- Player List -->
                        <CollectionView x:Name="PlayersCollectionView"
                                        ItemsSource="{Binding JoinedPlayers}"
                                        SelectionMode="Single"
                                        HeightRequest="200"
                                        EmptyView="No players have joined yet.">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="0,8" ColumnDefinitions="Auto,*,Auto" Margin="0,4">
                                        <!-- Player Avatar -->
                                        <Frame Grid.Column="0"
                                               CornerRadius="20"
                                               HeightRequest="50"
                                               WidthRequest="50"
                                               Padding="0"
                                               IsClippedToBounds="True"
                                               BorderColor="{StaticResource BorderColor}">
                                            <!-- Default profile icon (shown when no image available) -->
                                            <Label Text="👤" 
                                                   FontSize="22" 
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding HasProfileImage, Converter={StaticResource InvertBoolConverter}}" />

                                            <!-- Profile image when available -->
                                            <Image Source="{Binding ProfileImageUrl}"
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Fill" 
                                                   VerticalOptions="Fill"
                                                   IsVisible="{Binding HasProfileImage}" />
                                        </Frame>

                                        <!-- Player Details -->
                                        <VerticalStackLayout Grid.Column="1" 
                                                           Spacing="2" 
                                                           VerticalOptions="Center"
                                                           Margin="15,0,0,0">
                                            <!-- Player Name -->
                                            <Label Text="{Binding Name}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource PrimaryTextColor}"/>

                                            <!-- Player Username -->
                                            <Label Text="{Binding Username}"
                                                   FontSize="14"
                                                   TextColor="{StaticResource SecondaryTextColor}"/>
                                        </VerticalStackLayout>

                                        <!-- Host Badge (only shown for host) -->
                                        <Frame Grid.Column="2" 
                                               IsVisible="{Binding IsHost}"
                                               BackgroundColor="{StaticResource PrimaryColor}"
                                               CornerRadius="12"
                                               Padding="8,3"
                                               Margin="0,0,5,0"
                                               VerticalOptions="Center">
                                            <Label Text="Host" 
                                                   TextColor="White" 
                                                   FontSize="12"
                                                   FontAttributes="Bold"/>
                                        </Frame>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Location Map -->
                <Frame Padding="0"
                       CornerRadius="10"
                       HasShadow="True"
                       BorderColor="{StaticResource BorderColor}"
                       BackgroundColor="{StaticResource CardBackgroundColor}"
                       HeightRequest="200">

                    <!-- This would be a Map control in a real app -->
                    <Grid BackgroundColor="#E8EAF6">
                        <Image Source="map_placeholder.png"
                               Aspect="AspectFill" />
                        <Label Text="Map View"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{StaticResource SecondaryTextColor}" />
                    </Grid>
                </Frame>

                <!-- Action Buttons -->
                <Button Text="{Binding JoinButtonText}"
                        BackgroundColor="{StaticResource PrimaryColor}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="25"
                        HeightRequest="55"
                        FontSize="16"
                        Margin="0,10,0,0"
                        IsEnabled="{Binding CanJoin}"
                        Command="{Binding JoinRunCommand}" />

                <Button Text="Share Run"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource PrimaryColor}"
                        BorderColor="{StaticResource PrimaryColor}"
                        BorderWidth="1"
                        FontAttributes="Bold"
                        CornerRadius="25"
                        HeightRequest="55"
                        FontSize="16"
                        Margin="0,0,0,20"
                        Command="{Binding ShareRunCommand}" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- Footer Navigation -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*,*,*,*"
              BackgroundColor="{StaticResource CardBackgroundColor}"
              HeightRequest="70"
              Margin="-20,0,-20,0"
              Padding="0,5,0,20">

            <VerticalStackLayout Grid.Column="0"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Spacing="2">
                <Label Text="🏠"
                       FontSize="20"
                       HorizontalOptions="Center" />
                <Label Text="Home"
                       FontSize="12"
                       TextColor="{StaticResource SecondaryTextColor}"
                       HorizontalOptions="Center" />

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnHomeNavigationClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="1"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Spacing="2">
                <Label Text="🏀"
                       FontSize="20"
                       TextColor="{StaticResource PrimaryColor}"
                       HorizontalOptions="Center" />
                <Label Text="Runs"
                       FontSize="12"
                       FontAttributes="Bold"
                       TextColor="{StaticResource PrimaryColor}"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="2"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Spacing="2">
                <Label Text="👥"
                       FontSize="20"
                       HorizontalOptions="Center" />
                <Label Text="Squad"
                       FontSize="12"
                       TextColor="{StaticResource SecondaryTextColor}"
                       HorizontalOptions="Center" />

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSquadNavigationClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="3"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Spacing="2">
                <Label Text="⚙️"
                       FontSize="20"
                       HorizontalOptions="Center" />
                <Label Text="Settings"
                       FontSize="12"
                       TextColor="{StaticResource SecondaryTextColor}"
                       HorizontalOptions="Center" />

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSettingsNavigationClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>