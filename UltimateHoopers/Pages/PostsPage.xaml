<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:controls="clr-namespace:UltimateHoopers.Controls"
             x:Class="UltimateHoopers.Pages.PostsPage"
             xmlns:viewmodels="clr-namespace:UltimateHoopers.ViewModels"
             xmlns:converters="clr-namespace:UltimateHoopers.Converters"
             Title="Posts"
             BackgroundColor="{StaticResource PageBackgroundColor}">

    <ContentPage.Resources>
        <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
        <converters:PostTypeToVisibilityConverter x:Key="PostTypeToVisibilityConverter" />
        <converters:LikedPostToHeartConverter x:Key="LikedPostToHeartConverter" />
        <converters:SavedPostToBookmarkConverter x:Key="SavedPostToBookmarkConverter" />
        <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto"
          Padding="0">

        <!-- Header - Instagram-style -->
        <Grid Grid.Row="0" 
              BackgroundColor="{StaticResource CardBackgroundColor}"
              Padding="10,10,10,10"
              HeightRequest="60">

            <Label Text="Ultimate Hoopers"
                   FontSize="22"
                   FontAttributes="Bold"
                   TextColor="{StaticResource PrimaryColor}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center" />

            <HorizontalStackLayout HorizontalOptions="End"
                                  VerticalOptions="Center">
                <Label Text="🔔"
                       FontSize="24"
                       Margin="0,0,15,0" />

                <Label Text="📩"
                       FontSize="24" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Content - Instagram-style Feed -->
        <RefreshView Grid.Row="1" 
                    IsRefreshing="{Binding IsRefreshing}" 
                    Command="{Binding RefreshCommand}">
            <CollectionView x:Name="PostsCollectionView"
                           ItemsSource="{Binding Posts}" 
                           SelectionMode="None"
                           EmptyView="No posts available. Pull to refresh.">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <VerticalStackLayout Spacing="0" 
                                             x:Name="postContainer"
                                             SizeChanged="OnPostContainerSizeChanged">
                            <!-- Post Header -->
                            <Grid ColumnDefinitions="Auto,*,Auto" 
                                  Padding="10" 
                                  BackgroundColor="{StaticResource CardBackgroundColor}">
                                <Frame Grid.Column="0" 
                                       CornerRadius="20" 
                                       HeightRequest="40" 
                                       WidthRequest="40" 
                                       Padding="0" 
                                       HasShadow="False"
                                       BorderColor="{StaticResource BorderColor}">
                                    <Image Source="{Binding ProfileImageURL}" 
                                          HeightRequest="40"
                                          WidthRequest="40"
                                          Aspect="AspectFill"
                                          IsVisible="{Binding ProfileImageURL, Converter={StaticResource StringNotEmptyConverter}}">
                                        <Image.Clip>
                                            <EllipseGeometry Center="20,20" RadiusX="20" RadiusY="20" />
                                        </Image.Clip>
                                    </Image>
                                    <Frame.Triggers>
                                        <DataTrigger TargetType="Frame" Binding="{Binding ProfileImageURL, Converter={StaticResource StringNotEmptyConverter}}" Value="False">
                                            <Setter Property="Content">
                                                <Setter.Value>
                                                    <Label Text="👤" 
                                                           FontSize="24" 
                                                           HorizontalOptions="Center" 
                                                           VerticalOptions="Center" />
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Frame.Triggers>
                                </Frame>

                                <VerticalStackLayout Grid.Column="1" 
                                                     Margin="10,0,0,0" 
                                                     VerticalOptions="Center">
                                    <Label Text="{Binding UserName}" 
                                           FontAttributes="Bold" 
                                           FontSize="14" 
                                           TextColor="{StaticResource PrimaryTextColor}" />
                                    <Label Text="{Binding RelativeTime}" 
                                           FontSize="12" 
                                           TextColor="{StaticResource SecondaryTextColor}" />
                                </VerticalStackLayout>

                                <Label Grid.Column="2" 
                                       Text="⋮" 
                                       FontSize="20" 
                                       HorizontalOptions="End" 
                                       VerticalOptions="Center">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=PostOptionsCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </Grid>

                            <!-- Post Content - Using AutoPlayVideoElement for videos -->
                            <Grid Background="LightGray" HeightRequest="400">
                                <!-- Image Post - Only show when PostType is 'image' -->
                                <Image Source="{Binding PostFileURL}"
                                       IsVisible="{Binding PostType, Converter={StaticResource PostTypeToVisibilityConverter}, ConverterParameter='image'}"
                                       Aspect="AspectFill"
                                       HorizontalOptions="FillAndExpand"
                                       VerticalOptions="FillAndExpand">
                                    <Image.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnImagePostTapped" />
                                    </Image.GestureRecognizers>
                                </Image>

                                <!-- Video Post - Only show when PostType is 'video' -->
                                <controls:AutoPlayVideoElement 
                                    x:Name="AutoPlayVideo"
                                    IsVisible="{Binding PostType, Converter={StaticResource PostTypeToVisibilityConverter}, ConverterParameter='video'}"
                                    VideoUrl="{Binding PostFileURL}"
                                    ThumbnailUrl="{Binding ThumbnailUrl}"
                                    Post="{Binding .}"
                                    IsVisibleInViewport="False"
                                    FullScreenRequested="OnVideoFullScreenRequested" />

                                <!-- Fallback for no media -->
                                <VerticalStackLayout IsVisible="{Binding PostFileURL, Converter={StaticResource StringNotEmptyConverter}, ConverterParameter='negate'}"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center">
                                  
                                </VerticalStackLayout>
                            </Grid>

                            <!-- Post Actions -->
                            <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto" 
                                  Padding="10" 
                                  BackgroundColor="{StaticResource CardBackgroundColor}">
                                <Label Grid.Column="0" 
                                       Text="{Binding LikedPost, Converter={StaticResource LikedPostToHeartConverter}}" 
                                       FontSize="24" 
                                       Margin="0,0,15,0">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=LikePostCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                <Label Grid.Column="1" 
                                       Text="💬" 
                                       FontSize="24" 
                                       Margin="0,0,15,0">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=CommentPostCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                <Label Grid.Column="2" 
                                       Text="📩" 
                                       FontSize="24">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=SharePostCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                <Label Grid.Column="4" 
                                       Text="{Binding SavedPost, Converter={StaticResource SavedPostToBookmarkConverter}}" 
                                       FontSize="24" 
                                       HorizontalOptions="End">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=SavePostCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </Grid>

                            <!-- Likes -->
                            <Label Text="{Binding Likes, StringFormat='{0} likes'}" 
                                   FontAttributes="Bold" 
                                   Margin="10,5,10,0" 
                                   BackgroundColor="{StaticResource CardBackgroundColor}"
                                   TextColor="{StaticResource PrimaryTextColor}" />

                            <!-- Caption -->
                            <VerticalStackLayout Padding="10,5,10,10" 
                                                 BackgroundColor="{StaticResource CardBackgroundColor}">
                                <Label TextColor="{StaticResource PrimaryTextColor}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding UserName}" FontAttributes="Bold" />
                                            <Span Text=" " />
                                            <Span Text="{Binding Caption}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <Label Text="{Binding PostCommentCount, StringFormat='View all {0} comments'}" 
                                       IsVisible="{Binding PostCommentCount, Converter={StaticResource GreaterThanZeroConverter}}"
                                       TextColor="{StaticResource SecondaryTextColor}" 
                                       Margin="0,5,0,0">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=ViewCommentsCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </VerticalStackLayout>

                            <!-- Separator -->
                            <BoxView Color="{StaticResource BorderColor}" 
                                     HeightRequest="10" 
                                     HorizontalOptions="Fill" />
                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Navigation Footer -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*,*,*,*,*"
              BackgroundColor="{StaticResource CardBackgroundColor}"
              HeightRequest="60"
              Padding="0,5,0,15">

            <VerticalStackLayout Grid.Column="0"
                                 HorizontalOptions="Center"
                                 Spacing="2">
                <Label Text="🏠"
                       FontSize="24"
                       HorizontalOptions="Center" />

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnHomeClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="1"
                                 HorizontalOptions="Center"
                                 Spacing="2">
                <Label Text="🔍"
                       FontSize="24"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource PrimaryColor}" />
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="2"
                                 HorizontalOptions="Center"
                                 Spacing="2">
                <Frame HeightRequest="32"
                       WidthRequest="32"
                       CornerRadius="6"
                       BorderColor="{StaticResource PrimaryColor}"
                       BackgroundColor="Transparent"
                       Padding="0">
                    <Label Text="+"
                           FontSize="24"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           TextColor="{StaticResource PrimaryColor}" />
                </Frame>

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnCreatePostClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="3"
                                 HorizontalOptions="Center"
                                 Spacing="2">
                <Label Text="❤️"
                       FontSize="24"
                       HorizontalOptions="Center" />

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnActivityClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>

            <VerticalStackLayout Grid.Column="4"
                                 HorizontalOptions="Center"
                                 Spacing="2">
                <Frame CornerRadius="15"
                       HeightRequest="30"
                       WidthRequest="30"
                       Padding="0"
                       HasShadow="False"
                       BorderColor="{StaticResource BorderColor}">
                    <Label Text="👤"
                           FontSize="18"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Frame>

                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnProfileClicked" />
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
        </Grid>

        <!-- Fullscreen Media Viewer (initially hidden) -->
        <Grid x:Name="fullscreenViewer" 
              IsVisible="false"
              BackgroundColor="Black"
              Grid.RowSpan="3">

            <!-- Image Viewer -->
            <Image x:Name="fullscreenImage"
                   IsVisible="false"
                   Aspect="AspectFit"
                   HorizontalOptions="FillAndExpand"
                   VerticalOptions="FillAndExpand">
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnFullscreenImageTapped" />
                    <PinchGestureRecognizer PinchUpdated="OnPinchUpdated" />
                    <PanGestureRecognizer PanUpdated="OnPanUpdated" />
                </Image.GestureRecognizers>
            </Image>

            <!-- Close Button -->
            <Button Text="✕"
                    Clicked="CloseFullscreenViewer"
                    BackgroundColor="#80000000"
                    TextColor="White"
                    BorderColor="Transparent"
                    FontSize="20"
                    WidthRequest="40"
                    HeightRequest="40"
                    CornerRadius="20"
                    Margin="20"
                    HorizontalOptions="End"
                    VerticalOptions="Start" />
        </Grid>
    </Grid>
</ContentPage>